#!/bin/bash

# TitanCoffeeRunRails Launch Script
# This script sets up and launches the Rails application

set -e  # Exit on any error

echo "ğŸš€ TitanCoffeeRunRails Launch Script"
echo "===================================="

# Check if we're i    echo "ğŸ” Running RuboCop..."
    
    # Use bundle exec as primary method to avoid bin stub issues
    if bundle exec rubocop --version >/dev/null 2>&1; then
        bundle exec rubocop
    else
        echo "âš ï¸  RuboCop not found in Gemfile. Skipping RuboCop check."
    fi
    
    echo "ğŸ”’ Running Brakeman security check..."ectory
if [ ! -f "Gemfile" ]; then
    echo "âš ï¸  Gemfile not found in current directory. Attempting to change to ~/TitanCoffeeRunRails..."
    cd ~/TitanCoffeeRunRails || { echo "âŒ Error: Could not change to ~/TitanCoffeeRunRails. Please ensure the directory exists."; exit 1; }
    if [ ! -f "Gemfile" ]; then
        echo "âŒ Error: Gemfile still not found in ~/TitanCoffeeRunRails. Please run this script from the project root directory."
        exit 1
    fi
fi


# Check Ruby version
echo "ğŸ“‹ Checking Ruby version..."
REQUIRED_RUBY="3.3.6"

if command -v rbenv &> /dev/null; then
    echo "ğŸ”§ Using rbenv for Ruby management"
    
    # Check if required Ruby version is installed
    if ! rbenv versions | grep -q "$REQUIRED_RUBY"; then
        echo "âš ï¸  Ruby $REQUIRED_RUBY not installed via rbenv"
        echo ""
        echo "Choose an option:"
        echo "1) Install Ruby $REQUIRED_RUBY (recommended)"
        echo "2) Continue with current Ruby version (may cause issues)"
        echo "3) Exit and install manually"
        echo ""
        read -p "Enter your choice (1/2/3): " ruby_choice
        
        case $ruby_choice in
            1)
                echo "ğŸ“¥ Installing Ruby $REQUIRED_RUBY..."
                echo "â³ This may take 5-15 minutes depending on your system..."
                echo "ğŸ’¡ You'll see compilation output - this is normal!"
                echo "ğŸ›‘ DO NOT interrupt this process - let it complete!"
                echo ""
                
                # Temporarily disable exit on error for the installation
                set +e
                
                # Start installation in background to show progress
                rbenv install "$REQUIRED_RUBY" --verbose &
                install_pid=$!
                
                # Show progress while waiting
                while kill -0 $install_pid 2>/dev/null; do
                    echo "â³ Still installing Ruby... ($(date '+%H:%M:%S'))"
                    sleep 30
                done
                
                # Wait for the process to complete and get exit code
                wait $install_pid
                install_result=$?
                
                # Re-enable exit on error
                set -e
                
                if [ $install_result -eq 0 ]; then
                    echo "âœ… Ruby $REQUIRED_RUBY installed successfully!"
                    # Reload rbenv to recognize new installation
                    rbenv rehash
                    rbenv local "$REQUIRED_RUBY"
                    echo "ğŸ”„ Set local Ruby version to $REQUIRED_RUBY"
                else
                    echo "âŒ Ruby installation failed with exit code: $install_result"
                    echo "ğŸ’¡ Common fixes:"
                    echo "   - Install build dependencies: sudo apt-get install build-essential"
                    echo "   - Try manually: rbenv install $REQUIRED_RUBY"
                    echo "   - Check rbenv doctor: curl -fsSL https://github.com/rbenv/rbenv-installer/raw/HEAD/bin/rbenv-doctor | bash"
                    exit 1
                fi
                ;;
            2)
                echo "âš ï¸  Continuing with available Ruby version..."
                # Don't set local version, use whatever is available
                ;;
            3|*)
                echo "âŒ Exiting. Install Ruby $REQUIRED_RUBY with: rbenv install $REQUIRED_RUBY"
                exit 1
                ;;
        esac
    else
        # Set local Ruby version if it's already installed
        rbenv local "$REQUIRED_RUBY"
    fi
    
elif command -v ruby &> /dev/null; then
    RUBY_VERSION=$(ruby -v)
    echo "âœ… Ruby found: $RUBY_VERSION"
    
    # Check if it's the right version
    if ! echo "$RUBY_VERSION" | grep -q "$REQUIRED_RUBY"; then
        echo "âš ï¸  Warning: Expected Ruby $REQUIRED_RUBY, but found: $RUBY_VERSION"
        read -p "Continue anyway? (y/N): " continue_anyway
        if [[ ! $continue_anyway =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
else
    echo "âŒ Error: Ruby not found. Please install Ruby $REQUIRED_RUBY"
    echo "ğŸ’¡ Consider using rbenv: https://github.com/rbenv/rbenv#installation"
    exit 1
fi

echo "âœ… Ruby version check complete"

# Check Bundler
echo "ğŸ“‹ Checking Bundler..."
if command -v bundle &> /dev/null; then
    echo "âœ… Bundler found"
else
    echo "âš ï¸  Bundler not found. Installing..."
    gem install bundler
fi

# Install dependencies
echo "ğŸ“¦ Installing Ruby dependencies..."
bundle install

# Database setup
echo "ğŸ—„ï¸  Setting up databases..."

# Check for existing databases (Rails 8 uses multiple SQLite databases)
PRIMARY_DB="db/development.sqlite3"
CACHE_DB="db/cache.sqlite3"
QUEUE_DB="db/queue.sqlite3"
CABLE_DB="db/cable.sqlite3"

# Function to check if any database exists
check_databases() {
    local db_count=0
    [ -f "$PRIMARY_DB" ] && ((db_count++))
    [ -f "$CACHE_DB" ] && ((db_count++))
    [ -f "$QUEUE_DB" ] && ((db_count++))
    [ -f "$CABLE_DB" ] && ((db_count++))
    echo $db_count
}

existing_dbs=$(check_databases)

if [ $existing_dbs -eq 0 ]; then
    echo "ğŸ“¥ No databases found. Creating fresh database setup..."
    
    # Temporarily disable exit on error to handle schema issues
    set +e
    bundle exec rails db:setup
    setup_result=$?
    set -e
    
    if [ $setup_result -ne 0 ]; then
        echo "âŒ Database setup failed!"
        echo ""
        echo "This usually happens when schema.rb doesn't exist yet."
        echo "Choose a fix:"
        echo "1) Run 'bin/rails db:migrate' to create schema.rb"
        echo "2) Rerun this script after manual fix"
        echo "3) Continue anyway (may cause Rails startup issues)"
        echo ""
        read -p "Enter your choice (1/2/3): " fix_choice
        
        case $fix_choice in
            1)
                echo "ğŸ”§ Running db:migrate to create schema.rb..."
                bundle exec rails db:create
                bundle exec rails db:migrate
                echo "âœ… Schema created. Attempting setup again..."
                bundle exec rails db:setup
                ;;
            2)
                echo "ğŸ”„ Please run the following manually, then rerun this script:"
                echo "   bin/rails db:migrate"
                echo ""
                echo "Rerunning script now..."
                exec "$0" "$@"  # Rerun the entire script
                ;;
            3)
                echo "âš ï¸  Continuing anyway - Rails may fail to start..."
                ;;
            *)
                echo "âŒ Invalid choice. Exiting."
                exit 1
                ;;
        esac
    else
        echo "âœ… Database setup completed successfully!"
    fi
elif [ $existing_dbs -eq 4 ]; then
    echo "âœ… All databases exist. Running migrations to ensure they're up to date..."
    bundle exec rails db:migrate
else
    echo "âš ï¸  Partial database setup detected ($existing_dbs/4 databases found)"
    echo "Found databases:"
    [ -f "$PRIMARY_DB" ] && echo "  âœ… Primary database"
    [ -f "$CACHE_DB" ] && echo "  âœ… Cache database"
    [ -f "$QUEUE_DB" ] && echo "  âœ… Queue database"
    [ -f "$CABLE_DB" ] && echo "  âœ… Cable database"
    echo ""
    echo "Choose an option:"
    echo "1) Reset all databases (recommended for clean start)"
    echo "2) Try to migrate existing databases"
    echo "3) Continue without database changes"
    echo ""
    read -p "Enter your choice (1/2/3): " db_choice
    
    case $db_choice in
        1)
            echo "ğŸ”„ Resetting all databases..."
            bundle exec rails db:drop db:setup
            ;;
        2)
            echo "ğŸ”„ Attempting to migrate existing databases..."
            bundle exec rails db:create db:migrate
            ;;
        3)
            echo "âš ï¸  Continuing without database changes..."
            ;;
        *)
            echo "âŒ Invalid choice. Exiting."
            exit 1
            ;;
    esac
fi

# Optional: Run tests
read -p "ğŸ§ª Would you like to run tests before starting? (y/N): " run_tests
if [[ $run_tests =~ ^[Yy]$ ]]; then
    echo "ğŸ§ª Running tests..."
    bundle exec rails test
fi

# Optional: Run code quality checks
read -p "ğŸ” Would you like to run code quality checks? (y/N): " run_quality
if [[ $run_quality =~ ^[Yy]$ ]]; then
    echo "ğŸ” Running RuboCop..."
    
    # Check if bin/rubocop exists and is executable, otherwise use bundle exec
    if [ -x "bin/rubocop" ]; then
        bin/rubocop
    elif [ -f "bin/rubocop" ]; then
        echo "ï¿½ Making bin/rubocop executable..."
        chmod +x bin/rubocop
        bin/rubocop
    else
        echo "ğŸ“ Using bundle exec rubocop..."
        bundle exec rubocop
    fi
    
    echo "ï¿½ğŸ”’ Running Brakeman security check..."
    
    # Same approach for brakeman
    if bundle exec brakeman --version >/dev/null 2>&1; then
        bundle exec brakeman
    else
        echo "âš ï¸  Brakeman not found in Gemfile. Skipping security check."
    fi
fi

echo ""
echo "ğŸ‰ Setup complete! Starting Rails server..."
echo "ğŸ“± Access the app at: http://localhost:3000"
echo "â¹ï¸  Press Ctrl+C to stop the server"
echo ""

# Start the Rails server
bundle exec rails server